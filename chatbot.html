<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Chatbot | MediScope</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="script.js" defer></script>
</head>
<body class="bg-gray-50">
    <!-- Same header as index.html -->
    <header class="bg-blue-600 text-white shadow-md">
        <!-- Include header from index.html -->
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Health Assistant Chatbot</h2>
            <button onclick="window.history.back()" class="flex items-center text-blue-600 hover:text-blue-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back
            </button>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="border-b px-4 py-3 flex items-center bg-blue-600 text-white">
                <div class="h-8 w-8 rounded-full bg-blue-200 flex items-center justify-center text-blue-600 font-semibold mr-2">
                    AI
                </div>
                <h3 class="font-medium">MediScope Assistant</h3>
                <div class="ml-auto flex items-center space-x-2">
                    <button id="voiceBtn" class="p-1 rounded-full hover:bg-blue-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </button>
                    <button id="clearChatBtn" class="p-1 rounded-full hover:bg-blue-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="chatContainer" class="h-96 overflow-y-auto p-4 space-y-4">
                <!-- Welcome message -->
                <div class="flex items-start space-x-2">
                    <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold shrink-0">
                        AI
                    </div>
                    <div class="bg-blue-50 rounded-lg p-3 max-w-xs md:max-w-md lg:max-w-lg">
                        <p>Hello! I'm your MediScope health assistant. How can I help you today? You can ask me about:</p>
                        <ul class="list-disc pl-5 mt-1 text-sm">
                            <li>Symptoms you're experiencing</li>
                            <li>Medication information</li>
                            <li>Health advice</li>
                            <li>Your diet/exercise plans</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="border-t p-4 bg-gray-50">
                <form id="chatForm" class="flex space-x-2">
                    <input type="text" id="chatInput" placeholder="Type your health question..." 
                          class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                        Send
                    </button>
                </form>
                <p class="text-xs text-gray-500 mt-2">MediScope Assistant does not replace professional medical advice. Always consult a doctor for serious concerns.</p>
            </div>
        </div>
        
        <div class="mt-6 bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">Common Health Questions</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                <button onclick="quickQuestion('What foods should I eat for high blood pressure?')" 
                       class="text-left p-3 bg-blue-50 rounded-lg hover:bg-blue-100 border border-blue-200 text-sm">
                    <div class="font-medium text-blue-700">Hypertension diet</div>
                    <div class="text-xs text-blue-500 mt-1">Diet for high BP</div>
                </button>
                <button onclick="quickQuestion('What are the symptoms of diabetes?')" 
                       class="text-left p-3 bg-green-50 rounded-lg hover:bg-green-100 border border-green-200 text-sm">
                    <div class="font-medium text-green-700">Diabetes signs</div>
                    <div class="text-xs text-green-500 mt-1">Symptoms to watch for</div>
                </button>
                <button onclick="quickQuestion('Best exercises for weight loss')" 
                       class="text-left p-3 bg-yellow-50 rounded-lg hover:bg-yellow-100 border border-yellow-200 text-sm">
                    <div class="font-medium text-yellow-700">Weight loss</div>
                    <div class="text-xs text-yellow-500 mt-1">Effective workouts</div>
                </button>
                <button onclick="quickQuestion('How to manage stress and anxiety?')" 
                       class="text-left p-3 bg-purple-50 rounded-lg hover:bg-purple-100 border border-purple-200 text-sm">
                    <div class="font-medium text-purple-700">Stress relief</div>
                    <div class="text-xs text-purple-500 mt-1">Mental health tips</div>
                </button>
            </div>
        </div>
    </main>

    <script>
        // Check authentication
        document.addEventListener('DOMContentLoaded', () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                window.location.href = 'index.html';
                return;
            }
            
            const user = JSON.parse(storedUser);
            initChatbot(user);
        });

        function initChatbot(user) {
            const chatContainer = document.getElementById('chatContainer');
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatInput');
            const voiceBtn = document.getElementById('voiceBtn');
            const clearChatBtn = document.getElementById('clearChatBtn');
            
            let voiceRecognition = null;
            let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
            
            // Load chat history if exists
            if (chatHistory.length > 0) {
                chatHistory.forEach(msg => {
                    addMessage(msg.role, msg.content, false);
                });
                scrollToBottom();
            }
            
            // Form submission
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMessage();
            });
            
            // Voice button click
            voiceBtn.addEventListener('click', toggleVoiceRecognition);
            
            // Clear chat button
            clearChatBtn.addEventListener('click', clearChatHistory);
            
            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Add user message to chat
                addMessage('user', message);
                chatInput.value = '';
                
                // Show typing indicator
                const typingIndicator = addMessage('ai', '', true);
                
                // Process message and get response (simulated here)
                setTimeout(() => {
                    // Remove typing indicator
                    chatContainer.removeChild(typingIndicator);
                    
                    // Generate response
                    const response = generateResponse(message, user);
                    addMessage('ai', response);
                    
                    // Save to chat history
                    chatHistory.push(
                        { role: 'user', content: message },
                        { role: 'ai', content: response }
                    );
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    
                    // Scroll to bottom
                    scrollToBottom();
                }, 1000 + Math.random() * 2000); // Simulate thinking time
            }
            
            function addMessage(role, content, isTyping = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start space-x-2 ${role === 'user' ? 'justify-end' : ''}`;
                
                if (role === 'user') {
                    messageDiv.innerHTML = `
                        <div class="bg-blue-100 rounded-lg p-3 max-w-xs md:max-w-md lg:max-w-lg">
                            <p>${content}</p>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-semibold shrink-0">
                            ${user.name.charAt(0).toUpperCase()}
                        </div>
                    `;
                } else {
                    if (isTyping) {
                        messageDiv.innerHTML = `
                            <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold shrink-0">
                                AI
                            </div>
                            <div class="bg-blue-50 rounded-lg p-3 max-w-xs md:max-w-md lg:max-w-lg">
                                <div class="flex space-x-1">
                                    <div class="h-2 w-2 bg-gray-400 rounded-full animate-bounce"></div>
                                    <div class="h-2 w-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                    <div class="h-2 w-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                                </div>
                            </div>
                        `;
                    } else {
                        messageDiv.innerHTML = `
                            <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold shrink-0">
                                AI
                            </div>
                            <div class="bg-blue-50 rounded-lg p-3 max-w-xs md:max-w-md lg:max-w-lg">
                                <p>${content}</p>
                            </div>
                        `;
                    }
                }
                
                chatContainer.appendChild(messageDiv);
                if (!isTyping) scrollToBottom();
                return messageDiv;
            }
            
            function generateResponse(message, user) {
                const lowerMsg = message.toLowerCase();
                
                // Health condition responses
                if (lowerMsg.includes('blood pressure') || lowerMsg.includes('hypertension')) {
                    return `For managing blood pressure, consider:\n1. Reducing sodium intake\n2. Eating potassium-rich foods like bananas and spinach\n3. Regular moderate exercise\n4. Limiting alcohol\n\nYour current BP plan recommends ${user.bmiHistory ? (user.bmiHistory[user.bmiHistory.length-1].bmi > 25 ? 'weight management and ' : '') : ''}30 mins of daily walking.`;
                }
                else if (lowerMsg.includes('diabet') || lowerMsg.includes('blood sugar')) {
                    return `Diabetes management tips:\n1. Monitor carb intake\n2. Choose low glycemic index foods\n3. Regular blood sugar checks\n4. Stay active\n\nYou can check your diet plan for balanced meal suggestions.`;
                }
                else if (lowerMsg.includes('weight') || lowerMsg.includes('bmi')) {
                    const bmiMsg = user.bmiHistory && user.bmiHistory.length > 0 ? 
                        `Your last recorded BMI was ${user.bmiHistory[user.bmiHistory.length-1].bmi.toFixed(1)}. ` : '';
                    return `${bmiMsg}For healthy weight management:\n1. Balanced diet with portion control\n2. Regular exercise (${user.exercisePlan ? user.exercisePlan.filter(d => d.isWorkoutDay).length+' days/week in your plan' : 'at least 3 days/week'})\n3. Stay hydrated\n4. Get adequate sleep`;
                }
                else if (lowerMsg.includes('exercise') || lowerMsg.includes('workout')) {
                    return `Based on your ${user.exercisePlan ? 'current plan' : 'profile'}, I recommend:\n1. ${user.exercisePlan ? '' : '3-5 days per week of '}moderate exercise\n2. Mix of cardio and strength training\n3. Proper warm-up and cool-down\n4. Listen to your body to prevent injury\n\nWould you like workout suggestions for today?`;
                }
                else if (lowerMsg.includes('diet') || lowerMsg.includes('nutrition') || lowerMsg.includes('food')) {
                    return `Nutrition advice:\n1. Eat a variety of fruits and vegetables\n2. Choose whole grains\n3. Lean proteins like fish and poultry\n4. Limit processed foods\n\n${user.dietPlan ? 'Your current diet plan focuses on balanced meals throughout the day.' : 'Would you like me to generate a personalized diet plan for you?'}`;
                }
                else if (lowerMsg.includes('symptom')) {
                    return `For symptom checking, please provide more details about:\n1. What you're experiencing\n2. How long it's been going on\n3. Any patterns you've noticed\n\nRemember I can't diagnose - consult a doctor for serious symptoms.`;
                }
                else if (lowerMsg.includes('stress') || lowerMsg.includes('anxiety')) {
                    return `Stress management techniques:\n1. Deep breathing exercises\n2. Regular physical activity\n3. Adequate sleep\n4. Mindfulness meditation\n5. Time management strategies\n\nWould you like me to guide you through a breathing exercise now?`;
                }
                
                // General responses
                if (lowerMsg.includes('hello') || lowerMsg.includes('hi')) {
                    return `Hello ${user.name.split(' ')[0]}! How can I assist with your health today?`;
                }
                else if (lowerMsg.includes('thank')) {
                    return "You're welcome! Is there anything else I can help with?";
                }
                else if (lowerMsg.includes('plan') || lowerMsg.includes('program')) {
                    return `You can check your ${user.dietPlan ? 'diet' : ''}${user.dietPlan && user.exercisePlan ? ' and ' : ''}${user.exercisePlan ? 'exercise' : ''} plans in their respective sections. Would you like me to open them for you?`;
                }
                
                // Default response
                return `I'm not sure I understand. Could you please rephrase your question or ask about:\n- Symptoms\n- Medications\n- Diet/Exercise\n- General health advice\n\nFor medical emergencies, please contact a doctor immediately.`;
            }
            
            function toggleVoiceRecognition() {
                if (!('webkitSpeechRecognition' in window)) {
                    addMessage('ai', "Sorry, voice recognition is not supported in your browser.");
                    return;
                }
                
                if (voiceRecognition && voiceRecognition.isListening) {
                    voiceRecognition.stop();
                    voiceRecognition = null;
                    voiceBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>';
                    return;
                }
                
                voiceRecognition = new webkitSpeechRecognition();
                voiceRecognition.continuous = false;
                voiceRecognition.interimResults = false;
                voiceRecognition.isListening = true;
                
                voiceBtn.innerHTML = '<div class="h-4 w-4 rounded-full bg-red-500 animate-pulse"></div>';
                
                voiceRecognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    chatInput.value = transcript;
                    voiceBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>';
                    voiceRecognition.isListening = false;
                    sendMessage();
                };
                
                voiceRecognition.onerror = () => {
                    addMessage('ai', "Sorry, I couldn't hear you properly. Please try again.");
                    voiceBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>';
                };
                
                voiceRecognition.start();
            }
            
            function clearChatHistory() {
                chatHistory = [];
                localStorage.removeItem('chatHistory');
                chatContainer.innerHTML = `
                    <div class="flex items-start space-x-2">
                        <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold shrink-0">
                            AI
                        </div>
                        <div class="bg-blue-50 rounded-lg p-3 max-w-xs md:max-w-md lg:max-w-lg">
                            <p>Hello! I'm your MediScope health assistant. How can I help you today? You can ask me about:</p>
                            <ul class="list-disc pl-5 mt-1 text-sm">
                                <li>Symptoms you're experiencing</li>
                                <li>Medication information</li>
                                <li>Health advice</li>
                                <li>Your diet/exercise plans</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            function quickQuestion(question) {
                chatInput.value = question;
                sendMessage();
            }
            
            function scrollToBottom() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
    </script>
</body>
</html>
