<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMI Calculator | MediScope</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="script.js" defer></script>
</head>
<body class="bg-gray-50">
    <!-- Same header as index.html -->
    <header class="bg-blue-600 text-white shadow-md">
        <!-- Include header from index.html -->
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">BMI Calculator</h2>
            <button onclick="window.history.back()" class="flex items-center text-blue-600 hover:text-blue-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4">Calculate Your BMI</h3>
                
                <form id="bmiForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="height" class="block text-sm font-medium text-gray-700 mb-1">Height (cm)</label>
                            <input type="number" id="height" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">Weight (kg)</label>
                            <input type="number" id="weight" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                        Calculate BMI
                    </button>
                </form>

                <div id="bmiResult" class="mt-6 hidden">
                    <div class="border-t pt-4">
                        <h4 class="text-lg font-medium mb-2">Your Results</h4>
                        <div class="flex items-center justify-between mb-4">
                            <p>Your BMI:</p>
                            <span id="bmiValue" class="text-xl font-bold"></span>
                        </div>
                        <div class="h-6 bg-gray-200 rounded-full overflow-hidden">
                            <div id="bmiBar" class="h-full transition-all duration-500"></div>
                        </div>
                        <p id="bmiCategory" class="mt-2 text-sm font-medium"></p>
                        <p id="bmiAdvice" class="mt-2 text-sm"></p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4">BMI History</h3>
                
                <div class="h-64">
                    <canvas id="bmiChart"></canvas>
                </div>
                
                <div id="noHistory" class="text-center py-8 text-gray-500 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="mt-2">No BMI history recorded yet</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h3 class="text-xl font-semibold mb-4">BMI Categories</h3>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BMI Range</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Health Risk</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium">Underweight</td>
                            <td class="px-6 py-4 whitespace-nowrap">&lt; 18.5</td>
                            <td class="px-6 py-4 whitespace-nowrap">Higher risk of nutritional deficiency</td>
                        </tr>
                        <tr class="bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap font-medium">Normal</td>
                            <td class="px-6 py-4 whitespace-nowrap">18.5 - 24.9</td>
                            <td class="px-6 py-4 whitespace-nowrap">Low risk</td>
                        </tr>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium">Overweight</td>
                            <td class="px-6 py-4 whitespace-nowrap">25 - 29.9</td>
                            <td class="px-6 py-4 whitespace-nowrap">Moderate risk</td>
                        </tr>
                        <tr class="bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap font-medium">Obese</td>
                            <td class="px-6 py-4 whitespace-nowrap">â‰¥ 30</td>
                            <td class="px-6 py-4 whitespace-nowrap">High risk</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Check authentication
        document.addEventListener('DOMContentLoaded', () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                window.location.href = 'index.html';
                return;
            }
            
            const user = JSON.parse(storedUser);
            initBMIPage(user);
        });

        // Initialize BMI page with user data
        function initBMIPage(user) {
            const bmiForm = document.getElementById('bmiForm');
            const bmiResult = document.getElementById('bmiResult');
            const bmiValue = document.getElementById('bmiValue');
            const bmiBar = document.getElementById('bmiBar');
            const bmiCategory = document.getElementById('bmiCategory');
            const bmiAdvice = document.getElementById('bmiAdvice');
            const noHistory = document.getElementById('noHistory');
            const chartCtx = document.getElementById('bmiChart').getContext('2d');
            
            let bmiChart;
            
            // Load BMI history if available
            if (user.bmiHistory && user.bmiHistory.length > 0) {
                noHistory.classList.add('hidden');
                renderBMIChart(user.bmiHistory);
            } else {
                noHistory.classList.remove('hidden');
            }
            
            // Form submission for BMI calculation
            bmiForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const height = parseFloat(document.getElementById('height').value);
                const weight = parseFloat(document.getElementById('weight').value);
                
                if (isNaN(height) || isNaN(weight) || height <= 0 || weight <= 0) {
                    alert('Please enter valid height and weight values');
                    return;
                }
                
                const bmi = calculateBMI(height, weight);
                displayBMIResult(bmi);
                saveBMIHistory(user, height, weight, bmi);
            });
            
            // Calculate BMI
            function calculateBMI(height, weight) {
                // Convert height from cm to m
                const heightInMeters = height / 100;
                return (weight / (heightInMeters * heightInMeters)).toFixed(1);
            }
            
            // Display BMI result
            function displayBMIResult(bmi) {
                bmiValue.textContent = bmi;
                
                // Set category and color based on BMI
                let category, color, advice;
                if (bmi < 18.5) {
                    category = 'Underweight';
                    color = 'bg-yellow-500';
                    advice = 'Consider consulting with a nutritionist to develop a healthy weight gain plan.';
                } else if (bmi < 25) {
                    category = 'Normal weight';
                    color = 'bg-green-500';
                    advice = 'Maintain your healthy habits with balanced diet and regular exercise.';
                } else if (bmi < 30) {
                    category = 'Overweight';
                    color = 'bg-orange-500';
                    advice = 'Focus on moderate exercise and healthy eating to reach a healthier weight.';
                } else {
                    category = 'Obese';
                    color = 'bg-red-500';
                    advice = 'Consider consulting a healthcare provider for weight management strategies.';
                }
                
                // Animate BMI bar
                const percentage = Math.min(100, (bmi / 40) * 100);
                bmiBar.className = `h-full transition-all duration-500 ${color}`;
                bmiBar.style.width = `${percentage}%`;
                
                bmiCategory.textContent = category;
                bmiCategory.className = `mt-2 text-sm font-medium ${color.replace('bg', 'text')}`;
                bmiAdvice.textContent = advice;
                
                bmiResult.classList.remove('hidden');
            }
            
            // Save BMI to user's history
            function saveBMIHistory(user, height, weight, bmi) {
                const bmiRecord = {
                    date: new Date().toISOString(),
                    height,
                    weight,
                    bmi: parseFloat(bmi)
                };
                
                user.bmiHistory = user.bmiHistory || [];
                user.bmiHistory.push(bmiRecord);
                
                // Update localStorage
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Update chart
                if (user.bmiHistory.length === 1) {
                    noHistory.classList.add('hidden');
                    renderBMIChart(user.bmiHistory);
                } else {
                    updateBMIChart(user.bmiHistory);
                }
                
                // Send notification
                sendBMIAlert(user, bmiRecord);
            }
            
            // Render BMI history chart
            function renderBMIChart(history) {
                const dates = history.map(record => 
                    new Date(record.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})
                );
                const bmis = history.map(record => record.bmi);
                
                if (bmiChart) {
                    bmiChart.destroy();
                }
                
                bmiChart = new Chart(chartCtx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'BMI',
                            data: bmis,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointBackgroundColor: '#3b82f6',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                suggestedMin: Math.max(0, Math.min(...bmis) - 5),
                                suggestedMax: Math.max(...bmis) + 5
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Update BMI chart
            function updateBMIChart(history) {
                const dates = history.map(record => 
                    new Date(record.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})
                );
                const bmis = history.map(record => record.bmi);
                
                bmiChart.data.labels = dates;
                bmiChart.data.datasets[0].data = bmis;
                bmiChart.update();
            }
            
            // Send BMI alert notification
            function sendBMIAlert(user, bmiRecord) {
                const notifications = JSON.parse(localStorage.getItem('healthPortalNotifications')) || [];
                const notification = {
                    id: Date.now().toString(),
                    userId: user.id,
                    title: 'New BMI Record',
                    message: `Your BMI is ${bmiRecord.bmi} (${getBMICategory(bmiRecord.bmi)})`,
                    date: new Date().toISOString(),
                    seen: false
                };
                
                notifications.push(notification);
                localStorage.setItem('healthPortalNotifications', JSON.stringify(notifications));
                
                // Update UI if on index page
                const notificationBadge = document.getElementById('notificationBadge');
                if (notificationBadge) {
                    notificationBadge.classList.remove('hidden');
                }
            }
            
            function getBMICategory(bmi) {
                if (bmi < 18.5) return 'Underweight';
                if (bmi < 25) return 'Normal weight';
                if (bmi < 30) return 'Overweight';
                return 'Obese';
            }
        }
    </script>
</body>
</html>
